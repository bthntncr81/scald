name: Deploy Adonis + Inertia App (Multiple Projects)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸš€ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ› ï¸ Build Adonis.js App
        run: npm run build

      - name: ğŸ”„ Deploy to Server (Multiple Instances)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            for i in {1..10}; do
              PROJECT_PATH="/var/www/html/scald_$i"
              DB_NAME="resto_$i"
              PORT=$((4000 + i))

              echo "ğŸš€ Deploying to $PROJECT_PATH..."

              if [ ! -d "$PROJECT_PATH" ]; then
                mkdir -p "$PROJECT_PATH"
              fi
              
              cd "$PROJECT_PATH"

              if [ -d "build/public/uploads" ]; then
                mv build/public/uploads /tmp/uploads_backup_$i
              fi

              git pull origin main
              npm install
              npm run build

              # Create .env file with proper EOF handling
              cat > build/.env <<'END_ENV'
TZ=UTC
PORT=$PORT
HOST=0.0.0.0
LOG_LEVEL=info
APP_KEY=z47xQ6yWG0Ju4Rv47VO70zP3cYUdjkLc
NODE_ENV=production
SESSION_DRIVER=cookie
DB_HOST=localhost
DB_PORT=3306
DB_USER=resto_user
DB_PASSWORD=Bthntncr81.
DB_DATABASE=$DB_NAME
DRIVE_DISK=fs
SMTP_USERNAME=info@codius.solutions
SMTP_PASSWORD=Codius2024.
SMTP_HOST=smtpout.secureserver.net
SMTP_PORT=465
END_ENV

              # Fix variable substitution in .env file
              sed -i "s/\$PORT/$PORT/g" build/.env
              sed -i "s/\$DB_NAME/$DB_NAME/g" build/.env

              if [ -d "/tmp/uploads_backup_$i" ]; then
                mv /tmp/uploads_backup_$i build/public/uploads
              fi

              pm2 restart pos$i || pm2 start build/bin/server.js --name pos$i
              pm2 save
              
              echo "âœ… Deployment completed for $PROJECT_PATH (DB: $DB_NAME, PORT: $PORT)"
            done